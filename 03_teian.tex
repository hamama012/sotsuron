\chapter{提案手法}
本章では，本研究で開発するバーチャルペットについて述べる．

\section{概要}

%更に、コントローラの振動機能を利用し、ユーザとバーチャルペットが接触した際に振動を起こすことで、触覚再現とまではいかずとも触ったという感覚をユーザに返すことができる。

%また、HMDを利用するとユーザの視界から現実の物や環境が遮断されることから、仮想空間内の環境もユーザに大きな影響を与えることが推測される。これはVRを利用するバーチャルペットのみに発生する特性であり、セラピー効果に関連することが考えられる。この仮想空間内の環境は開発側が任意に変更できることから、仮想空間の自由性として考える。

本研究のシステム構成図を\ref{fig:system}に示す。
本システムはHTC Vive、コントローラ、ヘッドホンから成るデバイス部とUnityにより実装したペットシステム部から構成される。

\begin{figure}[htb]
\centering
\includegraphics*[width=12cm,clip]{images/提案手法図.eps}
\caption{提案システムの構成}
\label{fig:system}
\end{figure} 


ユーザはHTC Vive、ヘッドホンを装着し、コントローラを手に持った状態で仮想空間に没入する。
仮想空間にはペットとユーザの２つのアバターと、環境オブジェクトが存在する。ユーザの頭部の方向はHTC Viveに、手の動きはコントローラによってトラッキングされ、仮想空間上に反映される。コントローラはトリガーもしくはボタンが入力されれば、その情報をユーザ管理プログラムへと渡す。
ユーザアバターがペットアバターとの衝突を検知すると、ユーザ管理プログラムとペット管理プログラムへそれぞれ衝突情報が渡される。ユーザ管理プログラムからはコントローラへ振動命令が出され、コントローラが振動することでユーザに接触フィードバックを起こす。
ペット管理プログラムからはペットアバターのアニメータに尻尾

一連の動作を以下の図に示す。
システムを起動すると、ペットが自由に動き回る待機状態から開始する。ユーザがトリガーを深く引くと、ペットはユーザの位置まで移動し、ユーザの手前で停止する。この状態を触れ合い可能状態と呼ぶ。触れ合い可能状態では、ペットに触れることが可能になる。
この状態で再度トリガーを深く引くと、ペットは待機状態へと戻りフィールド内を自由に歩き回るようになる。

\subsection{仮想空間}

仮想空間の構築には、Unityを使用した。

仮想空間内の環境構築にはUnityのアセットストアで提供されているNature Starter Kit 2を使用し、森林空間を表した。より現実感を高めるため、WindZoneを配置することで風を吹かせ草などの背景オブジェクトが揺れるようにした。
更にNHKが配布している環境音素材である木々のざわめき、鳥のさえずりの二種類の音楽データを重ねて再生することで、森林らしさを追求した。

\begin{table}[htb]
\centering
\caption{スクリプト一覧}
\label{table:scriptList}
\scalebox{1.00}{
\begin{tabular}{|c||c|l|c|r|}
\hline
名前 & 説明 \\
\hline
petController & ペットの動作管理 \\
playerController & ユーザーの動作管理 \\
DirectionManager & ペットの視線移動における補完\\
\hline 
\end{tabular}}

\end{table}

\subsection{ユーザ}
ユーザの手の3DCGモデリングにはMayaを使用した。
ユーザの入力を表に示す。

\begin{table}[htb]
\centering
\caption{コントローラの入力一覧}
\label{table:userList}
\scalebox{1.00}{
\begin{tabular}{|c||c|l|c|r|}
\hline
入力 &　動作 \\
\hline
トリガーを深く引く & 待機状態と触れ合い可能状態への遷移 \\
メニューボタンを押す & 着席位置のリセット \\
グリップボタンを押す & シーンの切り替え \\
\hline 
\end{tabular}}
\end{table}

\subsection{バーチャルペット}

バーチャルペットの３DCGモデリングにはMayaを使用した。待機、歩く、走る、尻尾を振るの４種類のアニメーションが可能である。
ペットの動作を\ref{table:petList}に示す。

\begin{table}[htb]
\centering
\caption{ペットの動作一覧}
\label{table:petList}
\scalebox{1.00}{
\begin{tabular}{|c|c|r|}
\hline
動作一覧 \\
\hline
歩く \\
走る \\
尻尾を振る \\
視線先変更 \\
\hline 
\end{tabular}}
\end{table}

\section{ユーザ管理部}

ユーザ管理部はPlayerControllerとHandControllerの二つのスクリプトによって構成される。
PlayerControllerはSteamVRの〜にアタッチされており、コントローラ入力全般の処理を行う。
HandControllerは〜の子オブジェクトであるHandにアタッチされており、衝突情報をPlayerControllerに渡す処理を行う。
コントローラのトリガーが深く引かれると、bool変数callにtrueを代入する。callはクラス変数であり、trueのとき後に記述するペット管理プログラムにおいてトリガーが深く引かれた際のペットの動作処理を行う。
コントローラのメニューボタンが押された際にはHMDの着席位置のリセットを行う。




\section{バーチャルペット管理部}

ペット管理部はに示す４つのスクリプトによって構成される。

PetControllerは主にペットの動作全般の制御を行う。



%https://research.miyashita.com/2017/D174/D174.pdf

%http://archives.bukkyo-u.ac.jp/rp-contents/SO/0037/SO00370L099.pdf

%https://www.jstage.jst.go.jp/article/tvrsj/12/1/12_KJ00007499068/_pdf/-char/ja